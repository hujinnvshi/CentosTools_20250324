[mysqld]
# ======================
# 核心配置
# ======================
user = mysql
port = 6006
basedir = /data/mysql_5.7.39_v2/base
datadir = /data/mysql_5.7.39_v2/data
socket = /data/mysql_5.7.39_v2/mysql.sock
pid-file = /data/mysql_5.7.39_v2/mysql.pid
character-set-server = utf8mb4
collation-server = utf8mb4_general_ci
server-id = 10089
gtid_mode = ON
enforce_gtid_consistency = ON
skip_name_resolve = ON

# ======================
# 内存与缓冲池优化 (400GB分配)
# ======================
innodb_buffer_pool_size = 200G
innodb_buffer_pool_instances = 48      # 匹配48核CPU
innodb_buffer_pool_chunk_size = 1G
innodb_numa_interleave = ON            # NUMA内存优化

# ======================
# 日志系统优化 (RAID5顺序写优势)
# ======================
innodb_log_file_size = 4G              # 增大日志文件(原2G)
innodb_log_files_in_group = 4          # 总日志16GB
innodb_log_buffer_size = 256M
innodb_flush_log_at_trx_commit = 2     # 平衡安全与性能

# ======================
# I/O优化 (RAID5专用)
# ======================
innodb_io_capacity = 2000              # 提升IOPS能力
innodb_io_capacity_max = 4000
innodb_flush_method = O_DIRECT
innodb_use_native_aio = 1
innodb_flush_neighbors = 0             # RAID5无需邻近页刷新
innodb_read_io_threads = 16            # 增加读线程
innodb_write_io_threads = 16           # 增加写线程

# ======================
# 刷新策略优化
# ======================
innodb_adaptive_flushing = ON
innodb_max_dirty_pages_pct = 50        # 降低脏页比例
innodb_max_dirty_pages_pct_lwm = 20    # 提前刷新阈值
innodb_lru_scan_depth = 512            # 降低扫描深度

# ======================
# 连接与线程优化
# ======================
max_connections = 10000                # 合理降低连接数
max_user_connections = 9000
thread_cache_size = 1000               # 大缓存减少线程创建
thread_stack = 256K
back_log = 2000                        # 增大连接请求队列
table_open_cache = 20000                # 提升表缓存
table_definition_cache = 5000
open_files_limit = 30000

# ======================
# 查询优化器
# ======================
query_cache_size = 0
query_cache_type = 0
innodb_adaptive_hash_index = OFF       # 禁用AHI减少冲突

# ======================
# 临时表与排序优化
# ======================
tmp_table_size = 1G
max_heap_table_size = 1G
sort_buffer_size = 4M
join_buffer_size = 4M
read_buffer_size = 256K
read_rnd_buffer_size = 1M

# ======================
# 二进制日志优化
# ======================
log-bin = /data/mysql_5.7.39_v2/log/binlog/mysql-bin
binlog_format = ROW
expire_logs_days = 3
binlog_cache_size = 64M
max_binlog_size = 256M
sync_binlog = 100                      # 组提交优化
binlog_order_commits = ON

# ======================
# 压缩优化 (RAID5适用)
# ======================
# innodb_compression_algorithm = zlib
# innodb_compression_level = 6           # 中等压缩级别
# innodb_compression_failure_threshold_pct = 5

# ======================
# 统计信息优化
# ======================
innodb_stats_persistent_sample_pages = 100
innodb_stats_auto_recalc = 0
innodb_stats_on_metadata = OFF

# ======================
# 日志配置
# ======================
log-error = /data/mysql_5.7.39_v2/log/error.log
slow_query_log = 1
slow_query_log_file = /data/mysql_5.7.39_v2/log/slow.log
long_query_time = 3
log_queries_not_using_indexes = 1
log_throttle_queries_not_using_indexes = 50

# ======================
# 安全配置
# ======================
local-infile = 0
max_allowed_packet = 128M
secure-file-priv = NULL

# ======================
# 高级优化
# ======================
innodb_autoinc_lock_mode = 2
innodb_file_per_table = ON
innodb_checksum_algorithm = crc32
innodb_monitor_enable = all

# 增加锁系统容量
innodb_lock_wait_timeout = 30
innodb_deadlock_detect = ON
innodb_print_all_deadlocks = ON
default-time-zone = '+8:00'
performance_schema = ON
event_scheduler = ON
lower_case_table_names = 1

# ======================
# 移除冲突项
# ======================
# 已删除重复的 innodb_log_files_in_group = 2

[mysqld_safe]
log-error = /data/mysql_5.7.39_v2/log/error.log
pid-file = /data/mysql_5.7.39_v2/mysql.pid
malloc-lib = /usr/lib64/libjemalloc.so.1