
[mysqld]
# ======================
# 基础配置
# ======================
user = mysql
port = 6006
basedir = /data/mysql_5.7.39_v2/base
datadir = /data/mysql_5.7.39_v2/data
socket = /data/mysql_5.7.39_v2/mysql.sock
pid-file = /data/mysql_5.7.39_v2/mysql.pid
character-set-server = utf8mb4
collation-server = utf8mb4_general_ci
explicit_defaults_for_timestamp = 1
server-id = 10089
gtid_mode = ON
enforce_gtid_consistency = ON

# ======================
# 内存与缓存优化 (机械硬盘优化)
# ======================
innodb_buffer_pool_size = 400G
innodb_buffer_pool_instances = 24  # 降低实例数减少管理开销
innodb_buffer_pool_chunk_size = 1G

# 日志文件优化 (机械硬盘避免过大日志)
innodb_log_file_size = 2G
innodb_log_files_in_group = 4       # 总日志大小8GB
innodb_log_buffer_size = 256M

# I/O配置优化
innodb_flush_method = O_DIRECT
innodb_use_native_aio = 1

# ======================
# 连接与线程优化
# ======================
max_connections = 12000
max_user_connections = 11000
thread_cache_size = 200
thread_stack = 256K
back_log = 1500                     # 连接请求队列

# 超时设置
wait_timeout = 300
interactive_timeout = 300

# ======================
# InnoDB引擎优化 (RAID 5专用)
# ======================
# I/O能力配置 (机械硬盘)
innodb_io_capacity = 500            # RAID 5 典型IOPS 500-1000
innodb_io_capacity_max = 1000
innodb_lru_scan_depth = 1024        # 降低扫描深度

# 刷新策略优化
innodb_flush_neighbors = 1           # 启用邻近页刷新
innodb_adaptive_flushing = ON
innodb_max_dirty_pages_pct = 70
innodb_max_dirty_pages_pct_lwm = 30

# 并发控制
innodb_read_io_threads = 8
innodb_write_io_threads = 8          # 匹配磁盘数量
innodb_purge_threads = 4
innodb_thread_concurrency = 0        # 自动并发控制

# 写操作优化
innodb_change_buffering = all        # 缓冲所有变更类型
innodb_doublewrite = ON              # RAID 5仍需要双写保证
innodb_log_files_in_group = 2        # 减少日志文件数但保持总大小

# ======================
# 查询优化器设置
# ======================
query_cache_size = 0                 # 完全禁用查询缓存
query_cache_type = 0

# ======================
# 临时表与排序优化
# ======================
tmp_table_size = 1G
max_heap_table_size = 1G
sort_buffer_size = 4M                # 降低排序缓冲区大小
join_buffer_size = 4M
read_buffer_size = 256K
read_rnd_buffer_size = 1M

# ======================
# 二进制日志优化
# ======================
log-bin = /data/mysql_5.7.39_v2/log/binlog/mysql-bin
binlog_format = ROW
expire_logs_days = 3
binlog_cache_size = 64M
max_binlog_size = 256M              # 减小binlog大小
sync_binlog = 100                   # 组提交优化，每100次事务同步一次
binlog_order_commits = ON

# ======================
# 日志配置
# ======================
log-error = /data/mysql_5.7.39_v2/log/error.log
slow_query_log = 1
slow_query_log_file = /data/mysql_5.7.39_v2/log/slow.log
long_query_time = 3                 # 稍高的慢查询阈值
log_queries_not_using_indexes = 1
log_throttle_queries_not_using_indexes = 50

# ======================
# 安全配置
# ======================
local-infile = 0
max_allowed_packet = 128M           # 降低包大小防阻塞
secure-file-priv = NULL
skip_name_resolve = ON

# ======================
# 其他优化
# ======================
lower_case_table_names = 1
event_scheduler = ON
default-time-zone = '+8:00'
table_open_cache = 5000
table_definition_cache = 2500
open_files_limit = 30000
performance_schema = ON
innodb_stats_on_metadata = OFF
innodb_autoinc_lock_mode = 2
innodb_file_per_table = ON

# 禁用预读 (机械硬盘不适用)
innodb_random_read_ahead = OFF
loose-innodb-read-only-optimize = OFF

# ======================
# 高级配置
# ======================
innodb_checksum_algorithm = crc32   # 较快的校验算法
innodb_monitor_enable = all         # 启用InnoDB监控
innodb_print_all_deadlocks = ON     # 记录所有死锁

[mysqld_safe]
log-error = /data/mysql_5.7.39_v2/log/error.log
pid-file = /data/mysql_5.7.39_v2/mysql.pid
malloc-lib = /usr/lib64/libjemalloc.so.1